// Config
const API_BASE = "https://api.downloader.local";
const ALLOWED_FORMATS = ["mp4", "mp3"];

// Main Class
class VideoDownloader {
    constructor() {
        this.downloadQueue = [];
        this.isProcessing = false;
    }

‎    // تحقق من صحة الرابط
    validateUrl(url) {
        const patterns = {
            youtube: /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+$/,
            instagram: /^(https?:\/\/)?(www\.)?(instagram\.com)\/.+$/,
            tiktok: /^(https?:\/\/)?(www\.)?(tiktok\.com)\/.+$/
        };

        return Object.keys(patterns).some(platform => patterns[platform].test(url));
    }

‎    // تحليل معلومات الفيديو
    async getVideoInfo(url) {
        try {
            const response = await fetch(`${API_BASE}/info`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });

            return await response.json();
        } catch (error) {
            throw new Error("فشل في تحليل معلومات الفيديو");
        }
    }

‎    // بدء التحميل
    async startDownload(url, format = 'mp4') {
        if (!this.validateUrl(url)) {
            throw new Error("رابط غير صالح");
        }

        if (!ALLOWED_FORMATS.includes(format)) {
            throw new Error("صيغة غير مدعومة");
        }

        const videoInfo = await this.getVideoInfo(url);
        
‎        // إضافة للقائمة
        this.downloadQueue.push({
            id: Date.now(),
            url,
            format,
            info: videoInfo,
            status: 'pending',
            progress: 0
        });

        if (!this.isProcessing) {
            this.processQueue();
        }
    }

‎    // معالجة قائمة التحميل
    async processQueue() {
        if (this.downloadQueue.length === 0) {
            this.isProcessing = false;
            return;
        }

        this.isProcessing = true;
        const download = this.downloadQueue[0];

        try {

download.status = 'downloading';
            this.updateProgress(download.id, 0);

            const response = await fetch(`${API_BASE}/download`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    url: download.url,
                    format: download.format
                })
            });

            if (!response.ok) throw new Error("فشل التحميل");

            const blob = await response.blob();
            this.updateProgress(download.id, 100);
            
‎            // تحميل الملف
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `video_${download.id}.${download.format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            download.status = 'completed';
        } catch (error) {
            download.status = 'failed';
            console.error(error);
        }

‎        // إزالة من القائمة
        this.downloadQueue.shift();
        
‎        // معالجة العنصر التالي
        this.processQueue();
    }

‎    // تحديث نسبة التقدم
    updateProgress(id, progress) {
        const download = this.downloadQueue.find(d => d.id === id);
        if (download) {
            download.progress = progress;
            this.emitProgressUpdate(download);
        }
    }

‎    // إرسال تحديثات التقدم
    emitProgressUpdate(download) {
        const event = new CustomEvent('downloadProgress', {
            detail: {
                id: download.id,
                progress: download.progress,
                status: download.status
            }
        });
        window.dispatchEvent(event);
    }
}

‎// مثال على الاستخدام
const downloader = new VideoDownloader();

‎// استماع لتحديثات التقدم

window.addEventListener('downloadProgress', (event) => {
    console.log(`تحميل ${event.detail.id}: ${event.detail.progress}%`);
});

// HTML Interface
document.getElementById('downloadBtn').addEventListener('click', async () => {
    const url = document.getElementById('urlInput').value;
    const format = document.getElementById('formatSelect').value;
    
    try {
        await downloader.startDownload(url, format);
    } catch (error) {
        console.error(error);
        alert(error.message);
    }
});

```

والـ PHP backend:

```php
<?php
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST');
header('Access-Control-Allow-Headers: Content-Type');

class VideoDownloader {
    private $supportedPlatforms = ['youtube', 'instagram', 'tiktok'];
    private $downloadPath = __DIR__ . '/downloads/';
    
    public function __construct() {
        if (!file_exists($this->downloadPath)) {
            mkdir($this->downloadPath, 0777, true);
        }
    }

    public function getVideoInfo($url) {
        $platform = $this->detectPlatform($url);
        if (!$platform) {
            throw new Exception("منصة غير مدعومة");
        }

        $command = "yt-dlp --dump-json " . escapeshellarg($url);
        $output = shell_exec($command);
        
        if (!$output) {
            throw new Exception("فشل في جلب معلومات الفيديو");
        }

        return json_decode($output, true);
    }

    public function downloadVideo($url, $format = 'mp4') {
        $platform = $this->detectPlatform($url);
        if (!$platform) {
            throw new Exception("منصة غير مدعومة");
        }

        $filename = uniqid('video_') . '.' . $format;
        $filepath = $this->downloadPath . $filename;

        $command = "yt-dlp -f 'best' -o " . escapeshellarg($filepath) . " " . escapeshellarg($url);
        exec($command, $output, $returnVar);

        if ($returnVar !== 0) {
            throw new Exception("فشل في تحميل الفيديو");
        }

        return $filepath;
    }

    private function detectPlatform($url) {
        foreach ($this->supportedPlatforms as $platform) {
            if (strpos($url, $platform) !== false) {
                return $platform;
            }
        }
        return null;
    }
}

// API Endpoints
$downloader = new VideoDownloader();

try {
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $input = json_decode(file_get_contents('php://input'), true);

        if (isset($input['url'])) {
            if (isset($_GET['action']) && $_GET['action'] === 'info') {
                $info = $downloader->getVideoInfo($input['url']);
                echo json_encode(['success' => true, 'data' => $info]);
            } else {
                $format = isset($input['format']) ? $input['format'] : 'mp4';
                $filepath = $downloader->downloadVideo($input['url'], $format);
                
                header('Content-Type: application/octet-stream');
                header('Content-Disposition: attachment; filename="' . basename($filepath) . '"');
                readfile($filepath);
                unlink($filepath); // حذف الملف بعد التحميل
            }
        } else {
            throw new Exception("الرجاء تحديد رابط الفيديو");
        }
    }
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(['success' => false, 'error' => $e->getMessage()]);
}
?>
