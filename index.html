<!DOCTYPE html>
<html dir="rtl">
<head>
<title>Moon Voice | دردشة صوتية</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
‎/* ... الستايل السابق ... */

‎/* إضافة ستايل جديد */
.modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.8);
display: flex;
justify-content: center;
align-items: center;
z-index: 1000;
}

.modal-content {
background: white;
padding: 2rem;
border-radius: 15px;
width: 90%;
max-width: 400px;
}

.share-screen-btn {
background: #10b981;
color: white;
padding: 0.8rem;
border-radius: 50%;
border: none;
cursor: pointer;
margin-left: 1rem;
font-size: 1.2rem;
}

.participants-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
gap: 1rem;
margin-top: 1rem;
}

.participant-card {
background: #f3f4f6;
padding: 1rem;
border-radius: 12px;
text-align: center;
}

.participant-avatar {
width: 60px;
height: 60px;
border-radius: 50%;
background: var(--primary);
color: white;
display: flex;
align-items: center;
justify-content: center;
margin: 0 auto 1rem;
font-size: 1.5rem;
}

.room-status {
background: #fef3c7;
color: #92400e;
padding: 0.5rem;
border-radius: 8px;
margin: 1rem 0;
text-align: center;
}
</style>
</head>
<body>

‎<!-- مودال إدخال الاسم -->
<div class="modal" id="nameModal">
<div class="modal-content">
<h2>أدخل اسمك</h2>
<input type="text" id="userName" placeholder="اسمك هنا" style="width: 100%; margin: 1rem 0;">
<button class="btn btn-primary" onclick="setUserName()">تم</button>
</div>
</div>

<div class="app-container">
‎<!-- ... الهيدر السابق ... -->

<div class="controls">
<button class="mic-btn" id="micBtn">🎤</button>
<button class="share-screen-btn" id="screenBtn">🖥️</button>
</div>

<div class="room-status" id="roomStatus"></div>

<div class="participants-grid" id="participantsList">
‎<!-- سيتم إضافة المشاركين هنا -->
</div>

‎<!-- ... باقي العناصر ... -->
</div>

<script>
let localStream;
let screenStream;
let peerConnections = {};

let userName = '';
let participants = new Set();
const MAX_PARTICIPANTS = 4;

// التحقق من الاسم عند بدء التطبيق
window.onload = () => {
document.getElementById('nameModal').style.display = 'flex';
};

// تعيين اسم المستخدم
function setUserName() {
const nameInput = document.getElementById('userName');
if (nameInput.value.trim()) {
userName = nameInput.value.trim();
document.getElementById('nameModal').style.display = 'none';
updateParticipants();
}
}

// تحديث قائمة المشاركين
function updateParticipants() {
const list = document.getElementById('participantsList');
list.innerHTML = '';

participants.forEach(name => {
list.innerHTML += `
<div class="participant-card">
<div class="participant-avatar">${name[0].toUpperCase()}</div>
<div class="participant-name">${name}</div>
</div>
`;
});

updateRoomStatus();
}

// تحديث حالة الغرفة
function updateRoomStatus() {
const status = document.getElementById('roomStatus');
status.textContent = `المشاركون: ${participants.size}/${MAX_PARTICIPANTS}`;
}

// إنشاء غرفة جديدة
async function createRoom() {
if (!userName) {
alert('الرجاء إدخال اسمك أولاً');
return;
}

await initMedia();
roomId = Math.random().toString(36).substr(2, 9);
participants.add(userName);
updateParticipants();
showRoomCode(roomId);
setupPeerConnection(true);
}

// الانضمام لغرفة
async function joinRoom() {
if (!userName) {
alert('الرجاء إدخال اسمك أولاً');
return;
}

if (participants.size >= MAX_PARTICIPANTS) {
alert('عذراً، الغرفة ممتلئة');
return;
}

const code = document.getElementById('roomInput').value.trim();
if(!code) {
alert('الرجاء إدخال كود الغرفة');
return;
}

await initMedia();
roomId = code;
participants.add(userName);
updateParticipants();
setupPeerConnection(false);
}

// تهيئة الوسائط
async function initMedia() {
try {
localStream = await navigator.mediaDevices.getUserMedia({ 
audio: true,
video: false
});
updateStatus('تم تفعيل المايكروفون');
} catch (err) {
updateStatus('خطأ في الوصول للمايكروفون');
console.error(err);
}
}

// مشاركة الشاشة

async function shareScreen() {
try {
screenStream = await navigator.mediaDevices.getDisplayMedia({
video: true,
audio: true
});

// إرسال مسار الشاشة لجميع المتصلين
Object.values(peerConnections).forEach(pc => {
screenStream.getTracks().forEach(track => {
pc.addTrack(track, screenStream);
});
});

updateStatus('جارٍ مشاركة الشاشة');

screenStream.getVideoTracks()[0].onended = () => {
stopScreenShare();
};
} catch (err) {
console.error('خطأ في مشاركة الشاشة:', err);
updateStatus('فشل في مشاركة الشاشة');
}
}

// إيقاف مشاركة الشاشة
function stopScreenShare() {
if (screenStream) {
screenStream.getTracks().forEach(track => track.stop());
screenStream = null;
updateStatus('تم إيقاف مشاركة الشاشة');
}
}

// إضافة مستمعي الأحداث
document.getElementById('createBtn').addEventListener('click', createRoom);
document.getElementById('joinBtn').addEventListener('click', joinRoom);
document.getElementById('micBtn').addEventListener('click', toggleMic);
document.getElementById('screenBtn').addEventListener('click', shareScreen);

// ... باقي الكود السابق ...
</script>
</body>
</html>
